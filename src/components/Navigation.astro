---
import ThemeSwitcher from './ThemeSwitcher.astro';
import LanguageSwitcher from './LanguageSwitcher.astro';
import Icon from './icons/Icon.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const textLinks: { label: string; href: string }[] = [
  { label: t('nav.home'), href: translatePath('/') },
  { label: t('nav.experience'), href: '#experience' },
  { label: t('nav.education'), href: '#education' },
  { label: t('nav.skills'), href: '#skills' },
  { label: t('nav.contact'), href: '#contact' },
];

interface Props {
  pageTitle: string;
}
const { pageTitle }: { pageTitle: string } = Astro.props;
---

<nav
  class="fixed top-0 left-0 right-0 z-50 border-b border-border-default bg-bg-primary/80 dark:bg-bg-primary/80 backdrop-blur-xl"
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16 items-center">
      <a
        href={translatePath('/')}
        class="font-display text-lg font-semibold text-text-primary"
      >
        {pageTitle}
      </a>

      <div class="hidden md:flex items-center gap-1">
        {
          textLinks.map(({ label, href }) => (
            <a
              href={href}
              class="px-3 py-2 text-sm font-medium text-text-tertiary hover:text-text-primary rounded-lg hover:bg-bg-tertiary dark:hover:bg-bg-secondary transition-colors"
            >
              {label}
            </a>
          ))
        }
        <a
          href="mailto:tomaz.starasinic@gmail.com"
          class="ml-2 px-4 py-2 bg-primary-500 text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition-colors"
        >
          {t('cta.primaryButton')}
        </a>
        <div class="ml-4 flex items-center gap-2 pl-4 border-l border-border-default">
          <LanguageSwitcher />
          <ThemeSwitcher />
        </div>
      </div>

      <div class="flex items-center gap-2 md:hidden">
        <LanguageSwitcher />
        <ThemeSwitcher />
        <menu-button>
          <template>
            <button
              class="p-2 rounded-lg text-text-tertiary hover:bg-bg-tertiary dark:hover:bg-bg-secondary transition-colors"
              aria-expanded="false"
            >
              <span class="sr-only">Menu</span>
              <Icon name="Menu" size={22} />
            </button>
          </template>
        </menu-button>
      </div>
    </div>
  </div>

  <noscript>
    <div class="md:hidden border-t border-border-default">
      <div class="px-4 py-3 space-y-1">
        {
          textLinks.map(({ label, href }) => (
            <a href={href} class="block px-3 py-2 text-sm text-text-primary hover:bg-bg-tertiary dark:hover:bg-bg-secondary rounded-lg">
              {label}
            </a>
          ))
        }
        <a href="mailto:tomaz.starasinic@gmail.com" class="block px-3 py-2 text-sm text-primary-500 font-medium">
          {t('cta.primaryButton')}
        </a>
      </div>
    </div>
  </noscript>

  <div id="menu-content" hidden class="md:hidden border-t border-border-default">
    <div class="px-4 py-3 space-y-1">
      {
        textLinks.map(({ label, href }) => (
          <a
            href={href}
            class="block px-3 py-2 text-sm text-text-primary hover:bg-bg-tertiary dark:hover:bg-bg-tertiary rounded-lg transition-colors"
          >
            {label}
          </a>
        ))
      }
      <a
        href="mailto:tomaz.starasinic@gmail.com"
        class="block px-3 py-2 text-sm text-primary-500 font-medium"
      >
        {t('cta.primaryButton')}
      </a>
    </div>
  </div>
</nav>

<script>
  class MenuButton extends HTMLElement {
    constructor() {
      super();
      this.appendChild(this.querySelector('template')!.content.cloneNode(true));
      const btn = this.querySelector('button')!;
      const menu = document.getElementById('menu-content')!;
      menu.hidden = true;

      const setExpanded = (expand: boolean) => {
        btn.setAttribute('aria-expanded', expand ? 'true' : 'false');
        menu.hidden = !expand;
      };

      btn.addEventListener('click', () => setExpanded(menu.hidden));

      const mediaQueries = window.matchMedia('(min-width: 768px)');
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        setExpanded(e.matches);
        btn.hidden = e.matches;
      };
      handleViewports(mediaQueries);
      mediaQueries.addEventListener('change', handleViewports);
    }
  }
  customElements.define('menu-button', MenuButton);
</script>
